<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>%UNITY_WEB_NAME%</title>
    <link id="main-style" rel="stylesheet" href="External/style.css">
    <script src="%UNITY_WEBGL_LOADER_URL%"></script>
    <script>
        var unityInstance = UnityLoader.instantiate("unityContainer", "%UNITY_WEBGL_BUILD_URL%", { onProgress: UnityLoadProgress });
        let portraitMode;
        try{
            portraitMode = !!JSON.parse(%UNITY_CUSTOM_PORTRAIT_MODE%);
        }
        catch(e){
            portraitMode=false;
        }
        //Doing first resize when page loads
        window.onload = () => {
            Resize();
        }

        //The event for when page refreshes or closes
        window.addEventListener('beforeunload', function (e) {
            OnUnload();
            console.log("Page unloaded");
        });


        //Updating the values in unity on resize
        window.addEventListener("resize", () => {
            Resize();
        });

        //Sending event info to unity onUnload
        function OnUnload() {
            unityInstance.SendMessage("_BrowserControls", "BrowserUnloaded");
        }


        //Sending event info to unity OnMouseLeave/Enter
        function OnAppLoaded() {
            document.getElementById("unityContainer").addEventListener("mouseenter", () => {
                unityInstance.SendMessage("_BrowserControls", "MouseEntered");
            });

            document.getElementById("unityContainer").addEventListener("mouseleave", () => {
                unityInstance.SendMessage("_BrowserControls", "MouseLeft");
            });
        }


        //When unity loads in the browser send event info that page loaded
        function UnityLoadProgress(gameInstance, progress) {
            if (progress == 1) {
                //gameInstance.logo.style.display = gameInstance.progress.style.display = "none";
                console.log("WEBGL LOADED SUCCESSFULLY..");

                setTimeout(() => {
                    unityInstance.SendMessage("_BrowserControls", "BrowserLoaded");
                    Resize();
                    OnAppLoaded();
                }, 2500);
            }
        }

        var isInFirstScreen = true;
        //Main resizing function
        function Resize() {

            let webglContainer = document.querySelector(".webgl");
            let webglMaxWidthString = (isInFirstScreen) ? getComputedStyle(webglContainer).maxWidth.split("px") : getComputedStyle(webglContainer).width.split("px");
            let maxWidth = webglMaxWidthString[0];

            var width = maxWidth;

            let aspectRatio;

            if(portraitMode){
                if(%UNITY_HEIGHT%>%UNITY_WIDTH%){
                    aspectRatio = %UNITY_HEIGHT%/%UNITY_WIDTH%;
                }else{
                    aspectRatio = %UNITY_WIDTH%/%UNITY_HEIGHT%;
                }
            }else{
                if(%UNITY_WIDTH%<%UNITY_HEIGHT%){
                    aspectRatio =%UNITY_WIDTH%/%UNITY_HEIGHT%;
                }else{
                    aspectRatio = %UNITY_HEIGHT%/%UNITY_WIDTH%;
                }
            }
                
            height = aspectRatio * width;


            let sizeObj = { "height": height, "width": width };
            const desktopPortraitModeMaxWidth = %UNITY_WIDTH%;
            console.log(desktopPortraitModeMaxWidth);
            if(portraitMode && !isMobile){
                webglContainer.style.width = desktopPortraitModeMaxWidth + "px";
                document.getElementById("unityContainer").style.maxWidth = desktopPortraitModeMaxWidth + "px";
            }else{
                document.getElementById("unityContainer").style.width = width + "px";
                document.getElementById("unityContainer").style.height = height + "px";
            }
               
    

            try {
                unityInstance.SendMessage("Main Camera", "LoadBrowserVariables", JSON.stringify(sizeObj));
            } catch {
                console.log("Main camera not found,maybe not a demo build");
            }
        }
        var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        //Core Functionality for dynamic page loading
        dynamicPageLoading("External/normal_screen_top.html", pageSelector, true);
        dynamicPageLoading("External/normal_screen_bottom.html", pageSelector, false);
        function dynamicPageLoading(url, callback, top) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    callback(this, top);
                } else { console.warn("Reponse not 200!") }

            };
            xhr.open('get', url, true);
            xhr.send();
        }

        function pageSelector(response, top) {
            var topContainer = document.getElementById("top-container");
            var bottomContainer = document.getElementById("bottom-container")
            if (top) {
                topContainer.innerHTML = response.responseText;
            }
            else {
                bottomContainer.innerHTML = response.responseText;
            }
        }

        function clearTopContent() {
            var topContainer = document.getElementById("top-container");
            topContainer.innerHTML = "";
        }

        function clearBottomContent() {
            var bottomContainer = document.getElementById("bottom-container");
            bottomContainer.innerHTML = "";
        }


    </script>
</head>

<body>
    <!--Nav bar-->
    <div id="top-container">

    </div>
    <div class="main-content">
        <div class="main-content--grid">
            <!-- Webgl content -->
            <div id="webgl" class="webgl">
                <div class="webgl-content" id="webgl-content">
                    <div id="unityContainer" style="width: %UNITY_WIDTH%px; height: %UNITY_HEIGHT%px"></div>
                </div>
            </div>
            <!--Band below Webgl content-->
            <div id="bottom-container">

            </div>
        </div>
    </div>
    </div>
    <!--Footer-->
    <footer>
        <p><a href="https://arcade.jrpg.com">A mobile-friendly Unity app resizing by Repulse</a></p>
    </footer>
</body>

</html>